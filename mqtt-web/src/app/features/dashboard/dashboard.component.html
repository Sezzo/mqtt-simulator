<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>MQTT Simulator Dashboard</h1>
    <p class="subtitle">Geräteübersicht und Verwaltung</p>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button
      mat-raised-button
      color="primary"
      (click)="openExportDialog()"
      [matTooltip]="'Alle Geräte exportieren'"
    >
      <mat-icon>download</mat-icon>
      Exportieren
    </button>
    <button
      mat-raised-button
      (click)="openImportDialog()"
      [matTooltip]="'Geräte aus JSON importieren'"
    >
      <mat-icon>upload</mat-icon>
      Importieren
    </button>
  </div>

  <!-- Filtering -->
  <div class="filter-section">
    <h3>Nach Typ filtern:</h3>
    <div class="filter-chips">
      <button
        mat-stroked-button
        [class.active]="selectedType === null"
        (click)="filterByType(null)"
      >
        Alle
      </button>
      <button
        *ngFor="let type of allDeviceTypes"
        mat-stroked-button
        [class.active]="selectedType === type"
        (click)="filterByType(type)"
      >
        <mat-icon [matTooltip]="type">{{ getDeviceIcon(type) }}</mat-icon>
        {{ type }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading$ | async" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Geräte werden geladen...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error$ | async as error" class="error-banner" role="alert">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
    <button mat-icon-button (click)="deviceState.clearError()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Devices Grid -->
  <div
    class="devices-grid"
    cdkDropList
    (cdkDropListDropped)="drop($event)"
    *ngIf="(loading$ | async) === false"
  >
    <mat-card
      *ngFor="let device of devices; trackBy: trackByDeviceId"
      class="device-card"
      cdkDrag
    >
      <!-- Card Header -->
      <mat-card-header>
        <div class="device-header-content">
          <div class="device-type-icon" [style.backgroundColor]="getDeviceColor(device.type)">
            <mat-icon>{{ getDeviceIcon(device.type) }}</mat-icon>
          </div>
          <div class="device-info">
            <h3>{{ device.name }}</h3>
            <p class="device-type">{{ device.type }}</p>
          </div>
        </div>
        <div class="device-header-actions">
          <!-- Quick Light Toggle -->
          <button
            *ngIf="device.type === 'light'"
            mat-icon-button
            (click)="toggleLightPower(device, $event)"
            [matTooltip]="(device.state?.data?.['state'] === 'ON' ? 'Ausschalten' : 'Einschalten')"
            [class.light-on]="device.state?.data?.['state'] === 'ON'"
            class="light-toggle"
          >
            <mat-icon>{{ device.state?.data?.['state'] === 'ON' ? 'lightbulb' : 'lightbulb_outline' }}</mat-icon>
          </button>

          <button
            mat-icon-button
            class="delete-btn"
            (click)="deleteDevice(device, $event)"
            [matTooltip]="'Löschen'"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </mat-card-header>

      <mat-divider></mat-divider>

      <!-- Card Content -->
      <mat-card-content>
        <!-- Device State -->
        <div class="state-section" *ngIf="device.state?.data">
          <h4>Zustand</h4>
          <div class="state-items">
            <div class="state-item" *ngFor="let key of (device.state?.data || {}) | keyvalue">
              <span class="state-key">{{ key.key }}:</span>
              <span class="state-value">
                <span *ngIf="typeof key.value === 'boolean'" class="badge" [class.on]="key.value">
                  {{ key.value ? 'AN' : 'AUS' }}
                </span>
                <span *ngIf="typeof key.value !== 'boolean'">{{ key.value }}</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Device Metadata -->
        <div class="metadata-section">
          <div class="meta-item">
            <span class="label">Template:</span>
            <span class="value">{{ device.templateId || '—' }}</span>
          </div>
          <div class="meta-item">
            <span class="label">Telemetrie:</span>
            <span class="value">{{ device.telemetryIntervalSec }}s</span>
          </div>
        </div>
      </mat-card-content>

      <!-- Card Actions -->
      <mat-card-actions>
        <button
          mat-button
          color="primary"
          [routerLink]="['/devices', device.id, 'edit']"
        >
          <mat-icon>edit</mat-icon>
          Bearbeiten
        </button>
        <button
          mat-button
          color="accent"
          [routerLink]="['/devices', device.id, 'control']"
        >
          <mat-icon>gamepad</mat-icon>
          Steuern
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="(devices$ | async)?.length === 0">
      <mat-icon>inbox</mat-icon>
      <h3>Keine Geräte gefunden</h3>
      <p>Erstellen Sie ein neues Gerät, um zu beginnen.</p>
      <button mat-raised-button color="primary" routerLink="/devices/new">
        <mat-icon>add</mat-icon>
        Gerät erstellen
      </button>
    </div>
  </div>

  <!-- Pagination Info -->
  <div class="pagination-info">
    <p>Geräte werden angezeigt...</p>
  </div>
</div>
